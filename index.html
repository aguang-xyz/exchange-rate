<!doctype html5>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" />
    
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-old-ie-min.css" />
    <![endif]-->
    
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css" />
    <!--<![endif]-->
    
    <title>Exchange History</title>
    
    <style>
      body {
        
        padding: 1em;
      }
      
      #graph-container {
        
        text-align: center;
      }
    </style>
  </head>
  
  <body>
    <form class="pure-form pure-form-stacked">

      <fieldset>
        <legend>
          Exchange Rate History.
        </legend>

        <div class="pure-g">
          <div class="pure-u-1 pure-u-md-1-2">
            <label for="base-currency">
              Base Currency
            </label>
            
            <select id="base-currency" class="pure-u-23-24">
              <option value="AUD" selected>AUD</option>
              <option value="NZD">NZD</option>
              <option value="USD">USD</option>
              <option value="CNY">CNY</option>
            </select>
          </div>

          <div class="pure-u-1 pure-u-md-1-2">
            <label for="target-currency">Target Currency</label>
            
            <select id="target-currency" class="pure-u-23-24">
              <option value="AUD">AUD</option>
              <option value="NZD" selected>NZD</option>
              <option value="USD">USD</option>
              <option value="CNY">CNY</option>
            </select>
          </div>
                                                                        
          <div class="pure-u-1 pure-u-md-1-2">
            <label for="from-date">From Date</label>
            
            <input id="from-date" class="pure-u-23-24" type="date" />
          </div>

          <div class="pure-u-1 pure-u-md-1-2">
            <label for="to-date">To Date</label>
            
            <input id="to-date" class="pure-u-23-24" type="date" />
          </div>
        </div>
      </fieldset>
      
      <div id="graph-container">
        <svg id="graph" />
      </div>
    </form>
    
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
      // Function to display alerts.
      const alert = (info) => window.alert(info);
      
      // Function to query exchange history.
      // The result will be a promise-wrapped array, for example:
      //   [{ date: new Date('2020-01-01', rate: 1.05 }]
      const query = (baseCurrency, targetCurrency, fromDate, toDate) =>
        fetch(`https://api.exchangeratesapi.io/history?base=${baseCurrency}&symbols=${targetCurrency}&start_at=${fromDate}&end_at=${toDate}`)
          .then(response => response.json())
          .then(({ rates }) =>
            Object
              .entries(rates)
              .map(([date, rate]) => ({ date: new Date(date), rate: rate[targetCurrency] }))
              .sort(({ date: x }, { date: y }) => x < y ? -1 : x > y ? 1 : 0)          
          );
      
      // Function to render exchange history graph.
      const renderGraph = (baseCurrency, targetCurrency, fromDate, toDate) => {
          
        // Validate parameters.
        if (!baseCurrency || !targetCurrency || !fromDate || !toDate) {
          return;
        }
        
        query(baseCurrency, targetCurrency, fromDate, toDate)
          .then(dataset => {
          
            // Dimensions.
            const
              width = Math.floor(window.innerWidth * 0.9),
              height = Math.floor(window.innerHeight * 0.5),
              padding = 30;
            
            // Scales.
            const
              xScale = d3
                .scaleTime()
                .domain([d3.min(dataset, ({ date }) => date), d3.max(dataset, ({ date }) => date)])
                .range([padding, width - padding]),
              yScale = d3
                .scaleLinear()
                .domain([d3.min(dataset, ({ rate }) => rate), d3.max(dataset, ({ rate }) => rate)])
                .range([height - padding, padding]);
          
            // Svg element.
            const svg = d3
              .select("#graph")
              .attr("width", width)
              .attr("height", height);
            
            // Clear old child-nodes.
            svg.selectAll('*').remove();
            
            // X-Axis.
            svg
              .append("g")
              .attr("transform", `translate(0,${height - padding})`)
              .call(d3.axisBottom(xScale));
            
            // Y-Axis.
            svg
              .append("g")
              .attr("transform", `translate(${padding},0)`)
              .call(d3.axisLeft(yScale));
            
            // Line.
            svg
              .append("path")
              .datum(dataset)
              .attr("fill", "none")
              .attr("stroke", "black")
              .attr("stroke-width", 1.5)
              .attr("stroke-linejoin", "round")
              .attr("stroke-linecap", "round")
              .attr("d", d3.line().x(({ date }) => xScale(date)).y(({ rate }) => yScale(rate)));
          
            // Tooltip.
            const tooltip = svg.append('g').attr('display', 'none');
          
            const tooltipRatio = 0.8;
          
            tooltip
              .append('rect')
              .attr('width', 220 * tooltipRatio)
              .attr('height', 60 * tooltipRatio)
              .attr('fill', 'rgba(255, 255, 255, 0.9)')
              .attr('stroke', 'black')
              .attr('stroke-width', 1)
              .attr('x', - 110 * tooltipRatio)
              .attr('y', - 30 * tooltipRatio);
          
            const tooltipTextRows = [
              tooltip
                .append('text')
                .attr('x', -103 * tooltipRatio)
                .attr('y', -7 * tooltipRatio)
                .attr('font-size', 16 * tooltipRatio),
              tooltip
                .append('text')
                .attr('x', -103 * tooltipRatio)
                .attr('y', 23 * tooltipRatio)
                .attr('font-size', 16 * tooltipRatio),
            ];
          
            svg.on("touchmove mousemove", () => {

              const mouseX = d3.mouse(d3.event.currentTarget)[0];

              let minDistance = Infinity, minOrder = null;

              dataset.forEach(({ date, rate }, order) => {

                const currentDistance = Math.abs(xScale(date) - mouseX);

                if (currentDistance < minDistance) {

                  minDistance = currentDistance;
                  minOrder = order;
                }
              });

              if (minOrder !== null) {

                const { date, rate } = dataset[minOrder];

                tooltip
                  
                  .attr('display', '')
                  .attr('transform', `translate(${xScale(date)}, ${yScale(rate)})`);

                tooltipTextRows[0].text(`1 ${baseCurrency} = ${rate} ${targetCurrency}`);
                tooltipTextRows[1].text(`${date.toDateString()}`);
              }
            });
          
            // TODO: mouseleave...
          })
          .catch(err => {

            // Log errors.
            console.error('Failed to load data.', err);
          });
      };
      
      // Bind callback after the content has been loaded.
      document.addEventListener('DOMContentLoaded', () => {

        // Get all input elements.
        const inputs = {
          baseCurrency: document.getElementById('base-currency'),
          targetCurrency: document.getElementById('target-currency'),
          fromDate: document.getElementById('from-date'),
          toDate: document.getElementById('to-date'),
        };
        
        // Function to refresh graph.
        const refreshGraph = () => {
          
          const
            baseCurrency = inputs.baseCurrency.value,
            targetCurrency = inputs.targetCurrency.value,
            fromDate = inputs.fromDate.value,
            toDate = inputs.toDate.value;
          
          window.localStorage.formData = JSON.stringify({
            baseCurrency, targetCurrency, fromDate, toDate
          });
          
          renderGraph(baseCurrency, targetCurrency, fromDate, toDate);
        }
        
        // Bind callbacks for input changes.
        Object
          .values(inputs)
          .forEach(input => input.addEventListener('change', refreshGraph));
        
        if (window.localStorge.formData) {
          
          try {
            const { baseCurrency, targetCurrency, fromDate, toDate } = JSON.parse(window.localStorage.formData);
            
            renderGraph(baseCurrency, targetCurrency, fromDate, toDate);
          } catch (error) {
            
            console.error(error);
          }
        }
      });
    </script>
  </body>
</html>
